"use strict";(self.webpackChunkdocs_vantage_sh=self.webpackChunkdocs_vantage_sh||[]).push([[2558],{3905:(e,t,n)=>{n.d(t,{Zo:()=>u,kt:()=>g});var o=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function a(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,o)}return n}function s(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?a(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):a(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function i(e,t){if(null==e)return{};var n,o,r=function(e,t){if(null==e)return{};var n,o,r={},a=Object.keys(e);for(o=0;o<a.length;o++)n=a[o],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(o=0;o<a.length;o++)n=a[o],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var l=o.createContext({}),c=function(e){var t=o.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):s(s({},t),e)),n},u=function(e){var t=c(e.components);return o.createElement(l.Provider,{value:t},e.children)},h="mdxType",p={inlineCode:"code",wrapper:function(e){var t=e.children;return o.createElement(o.Fragment,{},t)}},d=o.forwardRef((function(e,t){var n=e.components,r=e.mdxType,a=e.originalType,l=e.parentName,u=i(e,["components","mdxType","originalType","parentName"]),h=c(n),d=r,g=h["".concat(l,".").concat(d)]||h[d]||p[d]||a;return n?o.createElement(g,s(s({ref:t},u),{},{components:n})):o.createElement(g,s({ref:t},u))}));function g(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var a=n.length,s=new Array(a);s[0]=d;var i={};for(var l in t)hasOwnProperty.call(t,l)&&(i[l]=t[l]);i.originalType=e,i[h]="string"==typeof e?e:r,s[1]=i;for(var c=2;c<a;c++)s[c]=n[c];return o.createElement.apply(null,s)}return o.createElement.apply(null,n)}d.displayName="MDXCreateElement"},516:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>s,default:()=>p,frontMatter:()=>a,metadata:()=>i,toc:()=>c});var o=n(7462),r=(n(7294),n(3905));const a={id:"kubernetes_container_insights",title:"Kubernetes (Container Insights)",description:"This page walks through how to integrate your Kubernetes costs via Container Insights in Vantage.",keywords:["Kubernetes","Container Insights"]},s="Kubernetes (Container Insights)",i={unversionedId:"kubernetes_container_insights",id:"kubernetes_container_insights",title:"Kubernetes (Container Insights)",description:"This page walks through how to integrate your Kubernetes costs via Container Insights in Vantage.",source:"@site/docs/kubernetes_container_insights.md",sourceDirName:".",slug:"/kubernetes_container_insights",permalink:"/kubernetes_container_insights",draft:!1,editUrl:"https://github.com/vantage-sh/docs.vantage.sh/blob/master/docs/kubernetes_container_insights.md",tags:[],version:"current",frontMatter:{id:"kubernetes_container_insights",title:"Kubernetes (Container Insights)",description:"This page walks through how to integrate your Kubernetes costs via Container Insights in Vantage.",keywords:["Kubernetes","Container Insights"]},sidebar:"someSidebar",previous:{title:"Kubernetes (OpenCost)",permalink:"/opencost"},next:{title:"Kubernetes Costs",permalink:"/kubernetes"}},l={},c=[{value:"Deploy CloudWatch Agent with Cross-Account ARN",id:"deploy-cloudwatch-agent-with-cross-account-arn",level:2},{value:"Adding Permissions for Node Roles",id:"adding-permissions-for-node-roles",level:2},{value:"Provision a Cross-Account Role",id:"provision-a-cross-account-role",level:2}],u={toc:c},h="wrapper";function p(e){let{components:t,...n}=e;return(0,r.kt)(h,(0,o.Z)({},u,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"kubernetes-container-insights"},"Kubernetes (Container Insights)"),(0,r.kt)("p",null,"Vantage follows the official ",(0,r.kt)("a",{parentName:"p",href:"https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/CloudWatch-Agent-common-scenarios.html#CloudWatch-Agent-send-to-different-AWS-account"},"AWS documentation")," on securely sending CloudWatch logs to another AWS account to ingest Kubernetes costs through Container Insights."),(0,r.kt)("admonition",{type:"note"},(0,r.kt)("p",{parentName:"admonition"},"The steps below are for users who choose to use Container Insights instead of the recommended ",(0,r.kt)("a",{parentName:"p",href:"/kubernetes_agent"},"Vantage Kubernetes agent")," integration.")),(0,r.kt)("h2",{id:"deploy-cloudwatch-agent-with-cross-account-arn"},"Deploy CloudWatch Agent with Cross-Account ARN"),(0,r.kt)("p",null,"The CloudWatch agent must be set up to collect metrics from your clusters. "),(0,r.kt)("p",null,"Refer to the ",(0,r.kt)("a",{parentName:"p",href:"https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/Container-Insights-setup-metrics.html"},"AWS Container Insights setup instructions"),". You will have to make one change on step 3 of these instructions and modify the\xa0",(0,r.kt)("inlineCode",{parentName:"p"},"cwagent-configmap.yml")," to include the ",(0,r.kt)("inlineCode",{parentName:"p"},"role_arn"),". Vantage will have provisioned this role for you already. See the steps below, in the ",(0,r.kt)("a",{parentName:"p",href:"#provision-a-cross-account-role"},"Provision a Cross-Account Role")," section."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},'# create configmap for cwagent config\napiVersion: v1\ndata:\n  # Configuration is in Json format. No matter what configure change you make,\n  # please keep the Json blob valid.\n  cwagentconfig.json: |\n    {\n      "agent": {\n        "credentials": {\n          "role_arn": "arn:aws:iam::<VANTAGE_ACCOUNT>:role/containerinsights-<CUSTOMER_NAME>"\n        }\n      },\n      "logs": {\n        "metrics_collected": {\n          "kubernetes": {\n            "metrics_collection_interval": 60\n          }\n        },\n        "force_flush_interval": 5\n      }\n    }\nkind: ConfigMap\nmetadata:\n  name: cwagentconfig\n  namespace: amazon-cloudwatch\n')),(0,r.kt)("h2",{id:"adding-permissions-for-node-roles"},"Adding Permissions for Node Roles"),(0,r.kt)("p",null,"Next, you will have to modify the IAM permissions of the Node Role that is used for your EKS Cluster roles. They step will require two changes:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"An inline policy that allows the role to ",(0,r.kt)("inlineCode",{parentName:"li"},"assumeRole")," the IAM role on the Vantage side."),(0,r.kt)("li",{parentName:"ul"},"Attachment of an AWS Managed Policy called\xa0",(0,r.kt)("inlineCode",{parentName:"li"},"CloudWatchAgentServerPolicy"),", which allows the node to send CloudWatch metrics.")),(0,r.kt)("p",null,"Each node will have to assume the role above to write logs to your Vantage account. That means that each ",(0,r.kt)("a",{parentName:"p",href:"https://docs.aws.amazon.com/eks/latest/userguide/create-node-role.html"},"node IAM role")," in your AWS account will need to attach the inline policy below."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "Version": "2012-10-17",\n  "Statement": [\n    {\n      "Effect": "Allow",\n      "Action": "sts:AssumeRole",\n      "Resource": "arn:aws:iam::<VANTAGE_ACCOUNT>:role/containerinsights-<CUSTOMER_NAME>"\n    }\n  ]\n}\n')),(0,r.kt)("admonition",{type:"note"},(0,r.kt)("p",{parentName:"admonition"},"If you use self-managed nodes on EKS, you will have to find out the node roles you have assigned within the cluster yourself.")),(0,r.kt)("p",null,"Now, attach the ",(0,r.kt)("inlineCode",{parentName:"p"},"CloudWatchAgentServerPolicy")," policy to each node role."),(0,r.kt)("h2",{id:"provision-a-cross-account-role"},"Provision a Cross-Account Role"),(0,r.kt)("p",null,"Vantage will provision an IAM role internally with the following trust policy and attach the ",(0,r.kt)("inlineCode",{parentName:"p"},"CloudWatchAgentServerPolicy")," managed policy."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "Version": "2012-10-17",\n  "Statement": [\n    {\n      "Effect": "Allow",\n      "Principal": {\n        "AWS": "arn:aws:iam::<CUSTOMER_AWS_ACCOUNT_ID>:root"\n      },\n      "Action": "sts:AssumeRole"\n    }\n  ]\n}\n')))}p.isMDXComponent=!0}}]);